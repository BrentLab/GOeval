---
title: "GOeval"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GOeval}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

First, install and load this package. It is easiest to use either the "devtools" or "remotes" package to do so. "remotes" is a smaller package, so it might be the better option if you do not want to install all of "devtools."

```{r, eval = FALSE}
# Uncomment the command before using.
#devtools::install_github("westbrooktm/GOeval", ref = "dev")
# OR
#remotes::install_github("westbrooktm/GOeval", ref = "dev")
```

```{r setup}
library("GOeval")
```

Steps to use this package from original network to graphing the results:

Begin with a network as a tab-separated .tsv file where the first column is the source nodes, the second column is the target nodes, and (if using subset_network) the third column is the edge scores. All genes should be written as their Ensembl gene ID.

1. subset_network to create network subsets with the top-weighted edges

2. webgestalt_network on each of the network subsets to generate ORA results

3. get_metrics on the stored ORA results to calculate summary statistics for plotting

4. plot_metrics using the output of get_metrics
\
\
\

To run the following examples, access the example data stored in "vignette_data.tar.gz" and extract it into a local folder.

```{r, eval = FALSE}
data_path <- system.file(package = "GOeval", file.path("data", "vignette_data.tar.gz"))

# where you want to store the example data
data_dir <- "data"

untar(data_path, exdir = data_dir)
```

```{r, echo = FALSE}
data_dir <- "data"
```

1. subset_network

"np3_dtoTFs.tsv" is tab-separated and contains 3 columns: the TFs, the regulated genes, and the scores.

This function sorts the input network in descending order by the values in the third column and creates files in the output_folder with only the first two columns of the rows that have the highest scores.

```{r}
  input_file <- file.path(data_dir, "np3_dtoTFs.tsv")
  
  # This does not have to be in the same directory as the input file.
  # Ensure your output_directory exists.
  output_directory <- file.path("data", "np3_dtoTFs_subsets")
  
  name <- "np3"
  
  # Since we are setting num_possible_TFs, this will be the average number of
  #   edges from each TF in each subset.
  edges <- c(8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096)
  
  # The "np3_dtoTFs.tsv" network was made to include only 56 TFs.
  num_possible_TFs <- 56
  
  subset_network(input_file, output_directory, name, edges, num_possible_TFs)
```

The result is that now the "data/np3_dtoTFs_subsets" folder contains 10 files: "np3_8.tsv" through "np3_4096.tsv".

2. webgestalt_network

Run ORA using the webgestalt_network function on each of the network subsets created in step 1.
These files are tab-separated with the first column containing the TF names and the second column containing the regulated gene names. 
"h1_k562_overlap_universe.txt" contains one column of the names of all genes that could appear in the network.
The network_name should be different for each subset, so I choose to use the subset file names without the extension.

Note organism = "hsapiens" and database = "geneontology_Biological_Process_noRedundant" is the default database for ORA.

You can see more options for organism and database with WebGestaltR::listOrganism() and WebGestaltR::listGeneSet() respectively.

```{r, eval = FALSE}
for (subset in list.files(file.path(data_dir, "np3_dtoTFs_subsets"), full.names = TRUE)) {
  # Again, the output_directory does not have to be in data_dir.
  webgestalt_network(network_path = subset,
                     reference_set = file.path(data_dir, "h1_k562_overlap_universe.txt"),
                     output_directory = file.path("data", "np3_dtoTFs_summaries"),
                     network_name = strsplit(basename(subset), "[.]")[[1]][1],
                     permutations = 3)
}
```

Also note that the run time of the above code could take well over an hour, so this vignette does not actually evaluate the code. The run time is highly dependent on the number of subsets, the number of TFs in each of those subsets, and the number of permutations. The process can be sped up (in this case by 10x) by running webgestalt_network on each subset at the same time using a computing cluster or similar.

To test the very basics on a personal computer, the following code should run in just a few minutes.

```{r, eval = FALSE}
webgestalt_network(network_path = file.path(data_dir, "np3_dtoTFs_subsets", "np3_8.tsv"),
                   reference_set = file.path(data_dir, "h1_k562_overlap_universe.txt"),
                   output_directory = file.path("data", "np3_dtoTFs_single_permutation"),
                   network_name = "np3_8",
                   permutations = 1)
```

3. get_metrics

Run get_metrics to calculate the desired metrics based on the output from webgestalt_network. Note the arguments 'get_sum' and 'get_size' are TRUE by default.

```{r}
  output_folders <- file.path(data_dir, "np3_dtoTFs_summaries")

  metric_dfs <- get_metrics(output_folders, get_percent = TRUE, get_mean = TRUE, get_median = TRUE, get_annotation_overlap = TRUE, parallel = FALSE)
```

If you want to compare multiple networks, you can run get_metrics on both at the same time as shown below with the addition of the "EDN" network. When comparing multiple networks, the sizes for all must be based either on total edges or on edges per TF, but the exact subset sizes do not need to be the same.

```{r, eval = FALSE}
  # Specify which folders contain the data for each network.
  # Each element will be a folder used as the output folder for a call to webgestalt_network.
  output_folders <- c(file.path(data_dir, "np3_dtoTFs_summaries"), file.path(data_dir, "EDN_summaries"))

  metric_dfs_by_net <- mapply(get_metrics, output_folders, MoreArgs=list(get_percent = TRUE, get_mean = TRUE, get_median = TRUE, get_annotation_overlap = TRUE, parallel = FALSE), SIMPLIFY = FALSE)
```

4. plot_metrics

Set a title and subtitle for the plots.\
Specify whether the subset sizes are based on total edges or edges per TF.\
Set the metric booleans to the same values as those used in get_metrics to ensure proper plot labels.\
\
plot_metrics also returns a list of the DataFrames used to plot. Each DataFrame contains values for one metric across all networks, subsets, and permutations

```{r}
  # Specify the main titles of the output graphs
  title_text <- "NP3"
  subtitle_text <- "subset for TFs accepted by DTO"
  
  perTF <- TRUE
  
  plot_data <- plot_metrics(metric_dfs, title_text, subtitle_text, perTF, percent = TRUE, mean = TRUE, median = TRUE, annotation_overlap = TRUE)
```
